<head>
  <script src="https://cdn.firebase.com/v0/firebase.js"></script>
  <link rel="stylesheet" href="codemirror.css" />
  <script src="codemirror.js"></script>
  <link rel="stylesheet" href="firepad.css" />
  <script src="firepad-min.js"></script>
  <script  type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script  type="text/javascript" src="http://cdn.jsdelivr.net/jquery.cookie/1.3/jquery.cookie.js"></script>
  <style>
    .firepad {
      width: 500px;
      height: 400px;
      background-color: #DDD;
    }
    .CodeMirror {
      background-color: #DDD;
    }
    #dialog-overlay {
    /* set it to fill the whole screen */
    width:100%; 
    height:100%;
     
    /* transparency for different browsers */
    filter:alpha(opacity=50); 
    -moz-opacity:0.5; 
    -khtml-opacity: 0.5; 
    opacity: 0.5; 
    background:#000; 
 
    /* make sure it appear behind the dialog box but above everything else */
    position:absolute; 
    top:0; left:0; 
    z-index:3000; 
 
    /* hide it by default */
    display:none;
  }

  #dialog-box {
      /* css3 drop shadow */
      -webkit-box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
      -moz-box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
       
      /* css3 border radius */
      -moz-border-radius: 5px;
      -webkit-border-radius: 5px;
       
      background:#fff;
      /* styling of the dialog box, i have a fixed dimension for this demo */
       
      /* make sure it has the highest z-index */
      position:absolute; 
      z-index:5000; 
   
      /* hide it by default */
      display:none;
  }

  #dialog-box .dialog-content {
      /* style the content */
      text-align:left; 
      //padding:10px; 
      //margin:13px;
      color:#666;
  }

  .modal-x-button {
     font-family:monospace;
      font-size:18px;
      position:absolute;
      right:5px;
      top:0px;
  }
  .modal-x-button:hover {
      cursor:hand;
      cursor:pointer;
  }

  </style>
</head>
<body>
  <div>
    <h1>StreetCodr</h1>
  </div>
  <hr>
  <div style="display:inline-block;margin-right:20px;">
    <span id="your_name"></span> (You):
    <div id="firepad1"></div>
    <a href="#">SUBMIT</a>
  </div>
  <div id="challenge-container" style="display:inline-block;">
    <div id="challenge-name">
    </div>
    <div id="challenge-text">
    </div>
  </div>
  <div style="display:inline-block;">
    <span id="their_name"></span>(Them):
    <div id="firepad2"></div>
    <a href="#">SUBMIT</a>
  </div>
  <div id="dialog-overlay">
    </div>
    <div id="dialog-box">
      <div class="dialog-content">
        <div id="dialog-message">
        </div>
      </div>
    </div>
  <div id="modals" style="display:none;">
    <div id="user-name-modal" style="text-align:center;height:200px;width:300px;padding-top:50px;">
        <h2>Welcome to StreetCodr!</h2>
        <label for="name">Enter your name:</label>
        <input type="text" name="name" id="name">
        <br>
        <button type="button">Go</button>
    </div>
    <div id="new-match-modal" style="text-align:center;height:200px;width:200px;padding-top:100px;">
        <h2>Welcome, <span id="name"></span></h2>
        <div>Wins: <span id="wins"></span></div>
        <div>Losses: <span id="losses"></span></div>
        <button type="button">Find an opponent</button>
    </div>
    <div id="end-match-modal" style="text-align:center;height:200px;width:200px;padding-top:100px;">
        <h2><span id="name"></span> wins!</h2>
        <button type="button">Click to play again</button>
    </div>
  </div>
    <script>
//******************************GLOBAL VARIABLES*******************************
      var user = null;
      var opponent = null;
      var session = null;
      var winLimit = 3;
      var usedChallenges = [];
      var roundNumber = 1;
      var challenge = null;
      var host = false;
      var userFirepad = null;
      var opponentFirepad = null;
      var userFirepadReady = false;
      var opponentFirepadReady = false;

      //Challenges data
      var challenges = [
        {"name": "String Reverse",
        "text": "Write a function that takes a string as input, and outputs the reverse.",
        "testcases":
          [
            {
              "input": "abcdefg",
              "output": "gfedcba"
            },
            {
              "input": "hello  world",
              "output": "dlrow  olleh"
            }
          ]
        } 
      ]

      //Powr hash
      var powrs = {
        "Freeze" : function(){

        },
        "BigFont" : function(){

        }
      }

//****************************UI FUNCTIONS**************************************
      $(document).ready(function () {   
        $(window).resize(function () {
          if (!$('#dialog-box').is(':hidden')) popup();
        });
        $(window).scroll(function () {
          if (!$('#dialog-box').is(':hidden')) popup();
        });
      });
 
      function close_popup() {
        $('#dialog-overlay, #dialog-box').fadeOut('fast');       
        return false;
      }

      function popup(message) {
        var maskHeight = window.innerHeight;
        var outerHeight = $(document).height();
        var maskWidth = $(window).width();

        $('#dialog-message').html(message);

        var dialogTop =  $(window).scrollTop() + (maskHeight/2) - ($('#dialog-box').height()/2);
        var dialogLeft = (maskWidth/2) - ($('#dialog-box').width()/2);
         
        $('#dialog-overlay').css({height:outerHeight, width:maskWidth}).show();
        $('#dialog-box').css({top:dialogTop, left:dialogLeft}).show();
      }
      
      function updateScreen(clear,winnerId) {
        if(clear){
          clearScreen();
        }
        //set challenge text
        if(winnerId){
          addWin(winnerId);
        }
        $("#your_name").html(user.name);
        $("#their_name").html(opponent.name);
        $("#challenge-name").html(getCurrentRound().challengeName);
        $("#challenge-text").html(challenges[challengeNameToIndex(getCurrentRound().challengeName)].text);
      }

      function clearScreen() {
        if(opponentFirepadReady){
          opponentFirepad.setText("");
        }
        if(userFirepadReady){
          userFirepad.setText("");
        }
      }
      
      function addWin(winnerId){
        //use winnerId to determine if you won or your opponent won
        //add a little dot to show the win or whatever
      }

//*****************************UTILITY FUNCTIONS*******************************
        function s4() {
        return Math.floor((1 + Math.random()) * 0x10000)
                   .toString(16)
                   .substring(1);
      };

      function guid() {
        return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
               s4() + '-' + s4() + s4() + s4();
      }

//*****************************CLASSES*************************************
      function User(id,name,wins,losses){
        var self = this;
        self.id = id;
        self.name = name;
        self.wins = wins;
        self.losses = losses;
      }

//*****************************FIREBASE FUNCTIONS*******************************
      function FB(path){
        return new Firebase("https://streetcodr.firebaseio.com" + path);
      }
      
      //Get the number of wins for that user in that session
      function getWins(sessionId, userId, callback){
        FB('/session/' + sessionId).once('value', function(data) {
          var wins=0;
          for(var i = 1; i<=5; i++){
            var round = data.val().round[i.toString()];
            if(round != undefined){
              var roundWinner = round.winner;
            }
            if(userId == roundWinner){
              wins++;
            }  
          }  
          callback(wins);
        });
      }
      
      function isSessionOver(callback){
        getWins(user.id, function(wins){
          if(wins >= winLimit){
            //we're done
            callback(true,user.id);
          }
          else{
            getWins(opponent.id, function(wins){
              if(wins>=winLimit){
                //we;re done
                callback(true,opponent.id);
              }
              else{
                //shit ain't over
                callback(false,opponent.id);
              }
            });
          }
        });
      }

      //Set opponent by id
      function setOpponent(id, callback){
        FB('/users/' + id).once('value', function(data) {
          opponent = data.val();
          callback();
        });
      }

      function getCurrentUser(callback){
        if($.cookie("userId")!=null) {
          var id = $.cookie("userId");
          FB("/users/" + id).once('value', function(data) {
            user = new User(id,data.val().name,data.val().wins,data.val().losses);
            callback(user);
          });          
        }
        else {
          callback(null);
        }
      }

      function newUser(id,name){
        user = new User(id,name,0,0);
        $.cookie("userId",id);
        FB("/users/" + id + "/name").set(name);
        FB("/users/" + id + "/wins").set(0);
        FB("/users/" + id + "/losses").set(0);
      }

      function addUserToQueue(callback) {
        FB("/queue").set(user.id);
        callback();
      }

      function getUserFromQueue(callback) {
        FB("/queue").once('value', function(data){
          FB("/queue").set(null);
          callback(data.val());
        });
      }

 //***************************MODALS********************************
      function showMatchModal(){
        popup($("#new-match-modal").clone());
        $("#new-match-modal #name").html(user.name);
        $("#new-match-modal #wins").html(user.wins);
        $("#new-match-modal #losses").html(user.losses);
        $("#new-match-modal button").click(function(){
          getOpponent();
        });
      }

      function askUserForName(callback){
        var id = guid();
        popup($("#user-name-modal").clone());
        $("#user-name-modal button").click(function(){
          var name = $("#name").val();
          newUser(id,name,0,0);
          callback();
        });
      }

      function showEndMatchModal(winnerId){
        popup($("#end-match-modal").clone());
        if(winnerId == user.id) {
          $("#end-match-modal #name").html(user.name);
        }
        else {
          $("#end-match-modal #name").html(opponent.name);
        }
        $("#end-match-modal button").click(function(){
          showMatchModal();
        });
      }

//***************************GAME ENGINE********************************
      function getCurrentRound(){
        rounds = session.round;
        for(var r in rounds){
          round = r;
        }
        return round;
      }

      function createSession(opponentId){
        var firepadRef1 = FB('/users/' + user.id + '/code');
        var codeMirror1 = CodeMirror(document.getElementById('firepad1'), { lineWrapping: true });
        userFirepad = Firepad.fromCodeMirror(firepadRef1, codeMirror1,
            { richTextShortcuts: true, richTextToolbar: true });
        userFirepad.on('ready', function() {
                userFirepadReady = true;
              });
        var firepadRef2 = FB('/users/' + opponentId + "/code");
        var codeMirror2 = CodeMirror(document.getElementById('firepad2'), { lineWrapping: true });
        opponentFirepad = Firepad.fromCodeMirror(firepadRef2, codeMirror2,
            { richTextShortcuts: true, richTextToolbar: true });
       opponentFirepad.on('ready', function() {
                opponentFirepadReady = true;
              });
        var sessionId = guid();
        var sessionRef = FB('/session/' + sessionId);
    
        var userRef = sessionRef.child(user.id);
        var oppRef = sessionRef.child(opponentId);
        
        var host = true;
        close_popup();
        
        setOpponent(opponentId,function(){
          //Initialize their power ups to empty
          userRef.child('powrups').set([]);
          oppRef.child('powrups').set([]);
          
          //Clear variables;
          usedChallenges = [];
          roundNumber = 1; 
          challenge = null;
                      
          nextRound(sessionId, roundNumber);
        });
      }
      
      //Initialize the next round
      //If winnerId is null, it's the first round! Yay!
      //Also handles the end of the game (if wins for winner > winLimit)
      function nextRound(sessionId, roundNumber, winnerId){
        
        roundNumber++;
        
        if(roundNumber == 2){ //It's the first round
          
          challenge = getChallenge();
          usedChallenges.push(challenge.name);
          FB('/session/' + sessionId + '/round/' + (roundNumber - 1) + '/challengeName').set(challenge.name);
          updateScreen(true);
          
        }
        else{
        
          getWins(sessionId, winnerId,function(wins){
            if( wins >= winLimit){
              //session over!
              showEndMatchModal(winnerId);
            }
            else{ //Not the last round yet
              challenge = getChallenge();
              usedChallenges.push(challenge.name);
              FB('/session/' + sessionId + '/round/' + (roundNumber - 1) + '/challengeName').set(challenge.name);
              updateScreen(true,winnerId);
            }   
          });
        }
        
      }
      
      //Turn the name of a challenge into its index
      function challengeNameToIndex(name){
        
        for(var i in challenges){
          if(challenges[i].name == name){
            return i;
          }
        }
        return null;
      }
      
      //Get a random, not-yet-used challenge
      function getChallenge(){
        
        var index = Math.round(Math.random() * (challenges.length - 1));
        
        while(usedChallenges.indexOf(challenges[index].name) >= 0){
          index = Math.round(Math.random() * (challenges.length - 1));
        }
        
        return challenges[index];
        
      }
      

      function getOpponent(){
        getUserFromQueue(function(opponentId){
          if(!opponentId) {
            addUserToQueue(waitForSession);
          }
          else {
            createSession(opponentId);
          }
        });  
      }

      function waitForSession() {
        $("#new-match-modal").html("Waiting...");
        session = FB("/session");
        session.once('child_changed',function(new_session){
          close_popup();
          var users = new_session.val().users;
          for(var i in users){
            if(i!=user.id){
              setOpponent(i,function(){
              var firepadRef1 = FB('/users/' + user.id + '/code');
              var codeMirror1 = CodeMirror(document.getElementById('firepad1'), { lineWrapping: true });
              userFirepad = Firepad.fromCodeMirror(firepadRef1, codeMirror1,
                  { richTextShortcuts: true, richTextToolbar: true });
              userFirepad.on('ready', function() {
                userFirepadReady = true;
              });
              var firepadRef2 = FB('/users/' + opponentId + "/code");
              var codeMirror2 = CodeMirror(document.getElementById('firepad2'), { lineWrapping: true });
              opponentFirepad = Firepad.fromCodeMirror(firepadRef2, codeMirror2,
                 { richTextShortcuts: true, richTextToolbar: true });
              opponentFirepad.on('ready', function() {
                opponentFirepadReady = true;
              });
                var rounds = FB("/session/" + new_session.id + "/round");
                rounds.on("child_changed",function(round){
                  isSessionOver(function(isOver,winnerId){
                    if(isOver){
                      rounds.off();
                      showEndMatchModal(winnerId);
                    }
                    else{
                      FB("/sesson/" + new_session.id).once("value",function(data){
                        session = data.val();
                        updateScreen(true);
                      }) 
                    }
                  });
                });
              });
            }
          }
        });
      }

      function evaluate(code){
        for(var i in challenge.testcases){
          eval("var __evaluator = " + code);
          if(__evaluator(challenge.testcases[i].input) != challenge.testcases[i].output) {
            return false;
          }
        }
        return true;
      }

//******************************INITIALIZATION***********************************
      $(function(){
        getCurrentUser(function(user){
          if(!user){
            askUserForName(showMatchModal);
          }
          else{
            showMatchModal();
          }
        });
      });

    </script>
</body>