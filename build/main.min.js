function resetGlobals(){opponent=null;session=null;winLimit=3;usedChallenges=[];roundNumber=1;challenge=null;host=false;userFirepad=null;opponentFirepad=null;$("#firepad1").html("");$("#firepad2").html("");if(user){FB("/users/"+user.id+"/code").set(null)}userFirepadReady=false;opponentFirepadReady=false;userWins=0;opponentWins=0;codeMirror1=null;codeMirror2=null;powrRefUser=null;powrRefOpponent=null}function close_popup(){$("#dialog-overlay, #dialog-box").fadeOut("fast");return false}function popup(e){var t=window.innerHeight;var n=$(document).height();var r=$(window).width();$("#dialog-message").html(e);var i=$(window).scrollTop()+t/2-$("#dialog-box").height()/2;var s=r/2-$("#dialog-box").width()/2;$("#dialog-overlay").css({height:n,width:r}).fadeIn("fast");setTimeout(function(){$("#dialog-box").css({top:i,left:s}).fadeIn("fast")},100)}function transition(e,t,n){popup("<div style='padding:30px;font-size:40px;'>"+(n?n:"")+"</div><div style='width:30px;padding-bottom:20px;font-size:100px;margin:0 auto;'>"+t+"</div>");var r=setInterval(function(){t--;popup("<div style='padding:30px;font-size:40px;'>"+(n?n:"")+"</div><div style='width:30px;padding-bottom:20px;font-size:100px;margin:0 auto;'>"+t+"</div>");if(t<1){clearInterval(r);setTimeout(function(){close_popup()},100);e()}},t*300)}function updateScreen(e){if(e){clearScreen()}getWins(session.id,user.id,function(e){userWins=e;getWins(session.id,opponent.id,function(e){opponentWins=e;$("#your_name").html(user.name);$("#their_name").html(opponent.name);$("#challenge-name").html(getCurrentRound().challengeName);$("#challenge-text").html(challenge.text);$("#user-wins").html(userWins);$("#opponent-wins").html(opponentWins)})})}function clearScreen(){if(userFirepadReady){if(challenge){userFirepad.setText("");userFirepad.setText(challenge.header)}else{userFirepad.setText("")}}}function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}function guid(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}function User(e,t,n,r){var i=this;i.id=e;i.name=t;i.wins=n;i.losses=r}function FB(e){return new Firebase("https://streetcodr.firebaseio.com"+e)}function getWins(e,t,n){FB("/session/"+e).once("value",function(e){var r=0;for(var i=1;i<=5;i++){var s=e.val().round[i.toString()];if(s!=undefined){var o=s.winner;if(t==o){r++}}}n(r)})}function isSessionOver(e){getWins(session.id,user.id,function(t){if(t>=winLimit){e(true,user.id)}else{getWins(session.id,opponent.id,function(t){if(t>=winLimit){e(true,opponent.id)}else{if(session.round&&session.round[getCurrentRound().id-1]){e(false,session.round[getCurrentRound().id-1].winner)}else{e(false)}}})}})}function setOpponent(e,t){FB("/users/"+e).once("value",function(n){opponent=n.val();opponent.id=e;t()})}function getCurrentUser(e){if($.cookie("userId")!=null){var t=$.cookie("userId");FB("/users/"+t).once("value",function(n){user=new User(t,n.val().name,n.val().wins,n.val().losses);e(user)})}else{e(null)}}function newUser(e,t){user=new User(e,t,0,0);$.cookie("userId",e);FB("/users/"+e+"/name").set(t);FB("/users/"+e+"/wins").set(0);FB("/users/"+e+"/losses").set(0)}function addUserToQueue(e){FB("/queue").set(user.id);e()}function getUserFromQueue(e){FB("/queue").once("value",function(t){FB("/queue").set(null);e(t.val())})}function showMatchModal(){$("#firepad1").html("");$("#firepad2").html("");popup($("#new-match-modal").clone());$("#new-match-modal #name").html(user.name);$("#new-match-modal #wins").html(user.wins);$("#new-match-modal #losses").html(user.losses);$("#new-match-modal button").click(function(){getOpponent()})}function askUserForName(e){var t=guid();popup($("#user-name-modal").clone());$("#user-name-modal button").click(function(){var n=$("#name").val();newUser(t,n,0,0);e()})}function showEndMatchModal(e){popup($("#end-match-modal").clone());if(e==user.id){$("#end-match-modal #name").html(user.name);FB("/users/"+user.id+"/wins").set(++user.wins)}else{$("#end-match-modal #name").html(opponent.name);FB("/users/"+user.id+"/losses").set(++user.losses)}$("#end-match-modal button").click(function(){showMatchModal()})}function submitCode(){var e=userFirepad.getText();var t=false;var n=false;try{t=evaluate(e)}catch(r){alert(r);n=true}if(t){nextRound(session.id,getCurrentRound().id,user.id)}else if(!n){alert("you are wrong and should be punished")}}function getCurrentRound(){rounds=session.round;for(var e in rounds){var t=e}var n=rounds[t];n.id=t;return n}function createSession(e){var t=FB("/users/"+user.id+"/code");codeMirror1=CodeMirror(document.getElementById("firepad1"),{lineWrapping:true,lineNumbers:true});userFirepad=Firepad.fromCodeMirror(t,codeMirror1,{richTextShortcuts:true,richTextToolbar:false});userFirepad.on("ready",function(){userFirepadReady=true});var n=FB("/users/"+e+"/code");codeMirror2=CodeMirror(document.getElementById("firepad2"),{lineWrapping:true,lineNumbers:true});opponentFirepad=Firepad.fromCodeMirror(n,codeMirror2,{richTextShortcuts:true,richTextToolbar:false});opponentFirepad.on("ready",function(){opponentFirepadReady=true});var r=guid();var i=FB("/session/"+r);var s=i.child("/users/"+user.id);var o=i.child("/users/"+e);var u=true;close_popup();setOpponent(e,function(){powrRefUser=s.child("powrs");powrRefOpponent=o.child("powrs");powrRefUser.child("Freeze").set(0);powrRefUser.child("Shrink Ray").set(0);powrRefUser.child("Magnifier").set(0);powrRefUser.child("powrUsed").set(null);powrRefOpponent.child("Freeze").set(0);powrRefOpponent.child("Shrink Ray").set(0);powrRefOpponent.child("Magnifier").set(0);powrRefOpponent.child("powrUsed").set(null);var e=false;powrRefOpponent.child("powrUsed").on("value",function(t){if(e==false){e=true}else{oppPowrs=t.val();updateScreen();if(oppPowrs!=null){usePowrOnSelf();powrRefOpponent.child("powrUsed").set(null)}}});usedChallenges=[];roundNumber=0;challenge=null;setTimeout(function(){nextRound(r,roundNumber)},100)})}function getPowrUsed(e){powrRefOpponent.child("powrUsed").once("value",function(t){e(t.val())})}function usePowrOnSelf(){getPowrUsed(function(e){powrs[e](true)})}function nextRound(e,t,n){t++;if(t==1){challenge=getChallenge();usedChallenges.push(challenge.name);FB("/session/"+e+"/round/"+t+"/challengeName").set(challenge.name);FB("/session/"+e).once("value",function(e){session=e.val();session.id=e.name();updateScreen(true);var t=FB("/session/"+session.id+"/round");t.on("child_added",function(e){FB("/session/"+session.id).once("value",function(e){session=e.val();session.id=e.name();isSessionOver(function(e,n){if(e){t.off();showEndMatchModal(n)}else{challenge=challenges[challengeNameToIndex(getCurrentRound().challengeName)];FB("/session/"+session.id).once("value",function(e){session=e.val();session.id=e.name();transition(function(){updateScreen(true);setTimeout(function(){if(opponentFirepad.getText().trim().length<2){t.off();transition(function(){getOpponent()},3,"Opponent disconnected.")}},2e3)},3,getCurrentRound().id>1?(n==user.id?user.name:opponent.name)+" won! Next round in...":"Found opponent! Starting in...")})}})})})})}else{FB("/session/"+session.id+"/round/"+(t-1)+"/winner").set(n);getWins(e,n,function(r){if(r>=winLimit){FB("/session/"+e+"/round/end").set("1")}else{challenge=getChallenge();usedChallenges.push(challenge.name);FB("/session/"+e+"/round/"+t+"/challengeName").set(challenge.name);FB("/session/"+e).once("value",function(e){session=e.val();session.id=e.name();updateScreen(true,n)})}})}}function usePowr(e){$("#canttouchthis").show();$("#canttouchthis").css({"background-color":"#CCC",opacity:".9"});$("#canttouchthis").animate({opacity:0},2e4,function(){$("#canttouchthis").hide()});powrs[e](false);powrRefUser.child("powrUsed").set(e)}function challengeNameToIndex(e){for(var t in challenges){if(challenges[t].name==e){return t}}return null}function getChallenge(){var e=Math.round(Math.random()*(challenges.length-1));while(usedChallenges.indexOf(challenges[e].name)>=0){e=Math.round(Math.random()*(challenges.length-1))}return challenges[e]}function getOpponent(){if(session){FB("/session/"+session.id).set(null)}resetGlobals();getUserFromQueue(function(e){if(!e){addUserToQueue(waitForSession)}else if(e!=user.id){createSession(e)}else{addUserToQueue(waitForSession)}})}function waitForSession(){close_popup();popup("<div style='text-align:center;height:320px;width:400px;'><div style='padding-top:120px;font-size:30px;'>Waiting...</div></div>");var e=FB("/session");e.once("child_changed",function(e){close_popup();e.id=e.name();session={id:e.id};var t=e.val().users;for(var n in t){if(n!=user.id){setOpponent(n,function(){powrRefUser=FB("/session/"+e.id+"/users/"+user.id+"/powrs");powrRefOpponent=FB("/session/"+e.id+"/users/"+opponent.id+"/powrs");var t=false;powrRefOpponent.child("powrUsed").on("value",function(e){if(t==false){t=true}else{oppPowrs=e.val();updateScreen();if(oppPowrs!=null){usePowrOnSelf();powrRefOpponent.child("powrUsed").set(null)}}});var n=FB("/users/"+user.id+"/code");codeMirror1=CodeMirror(document.getElementById("firepad1"),{lineWrapping:true,lineNumbers:true});userFirepad=Firepad.fromCodeMirror(n,codeMirror1,{richTextShortcuts:true,richTextToolbar:false});userFirepad.on("ready",function(){userFirepadReady=true});var r=FB("/users/"+opponent.id+"/code");codeMirror2=CodeMirror(document.getElementById("firepad2"),{lineWrapping:true,lineNumbers:true});opponentFirepad=Firepad.fromCodeMirror(r,codeMirror2,{richTextShortcuts:true,richTextToolbar:false});opponentFirepad.on("ready",function(){opponentFirepadReady=true});var i=FB("/session/"+e.id+"/round");i.on("child_added",function(t){FB("/session/"+e.id).once("value",function(t){session=t.val();session.id=t.name();isSessionOver(function(t,n){if(t){i.off();showEndMatchModal(n)}else{challenge=challenges[challengeNameToIndex(getCurrentRound().challengeName)];FB("/session/"+e.id).once("value",function(e){session=e.val();session.id=e.name();transition(function(){updateScreen(true)},3,getCurrentRound().id>1?(n==user.id?user.name:opponent.name)+" won! Next round in...":"Found opponent! Starting in...")})}})})})})}}})}function evaluate(code){var type="";type=eval("typeof("+code+")");if(type!="function"){return false}for(var i in challenge.testcases){eval("var __evaluator = "+code);if(__evaluator(challenge.testcases[i].input)!=challenge.testcases[i].output){return false}}return true}var user=null;var opponent=null;var session=null;var winLimit=3;var usedChallenges=[];var roundNumber=1;var challenge=null;var host=false;var userFirepad=null;var opponentFirepad=null;var userFirepadReady=false;var opponentFirepadReady=false;var userWins=0;var opponentWins=0;var codeMirror1=null;var codeMirror2=null;var powrRefUser=null;var powrRefOpponent=null;var challenges=[{name:"String Reverse",text:"Input: A string.\nReturn: The reverse of the string.\nHint: None.",header:"function(string){\n\n}",testcases:[{input:"abcdefg",output:"gfedcba"},{input:"hello  world",output:"dlrow  olleh"}]},{name:"Missing No.",text:"Input: An randomized array of unique integers from 1 to some N. BUT! There is one integer missing.\nReturn: The missing integer.\nHint: N = (array.length + 1)",header:"function(array){\n\n}",testcases:[{input:[6,9,3,4,5,1,2,10,8],output:7},{input:[1,2,3,4,5,6,7,8,9,10,15,14,13,12,16],output:11}]},{name:"High Prime",text:"Input: An integer N.\nReturn: The largest prime less than or equal to the input.\nHint: None",header:"function(n){\n\n}",testcases:[{input:1e3,output:997},{input:3,output:3},{input:56345,output:56333}]},{name:"Linear Combo",text:"Input: An object ints with fields ints.x, ints.y, and ints.z.\nReturn: True if z is a linear combination of x and y. False otherwise.\nHint: z is a linear combination of x and y if and only if Ax + By = z for some integers A and B.",header:"function(ints){\n\n}",testcases:[{input:{x:2,y:4,z:19},output:false},{input:{x:3,y:16,z:19},output:true},{input:{x:14,y:17,z:262},output:true},{input:{x:104,y:109,z:200},output:true}]},{name:"X-Clusters",text:"Input: A string.\nOutput: The number of clusters (any size) of the letter 'x'. \nHint: So \"xxyxabxxxhellox\" would return 4. ",header:"function(string){\n\n}",testcases:[{input:"xxyxabcxxxhellox",output:4},{input:"xxxxxxxxxx",output:1},{input:"xxxxxabcxxxxx",output:2},{input:"aaaaa4x4aaaaaaa",output:1},{input:"abcdefg",output:0}]}];var powrs={Freeze:function(e){$("#user-cover").clearQueue();$("#opponent-cover").clearQueue();if(e){codeMirror1.getInputField().blur();$("#user-cover").show();$("#user-cover").css({"background-color":"#68E",opacity:".4"});$("#user-cover").animate({opacity:0},5e3,function(){$("#user-cover").hide()})}else{$("#opponent-cover").css({"background-color":"#68E",opacity:".4"});$("#opponent-cover").animate({opacity:0},5e3,function(){})}},"Shrink Ray":function(e){$("#firepad2 .CodeMirror").clearQueue();$("#firepad2 .CodeMirror").clearQueue();if(e){$("#firepad1 .CodeMirror").css({"font-size":"1px"});$("#firepad1 .CodeMirror").animate({"font-size":14},1e4,function(){$("#user-cover").hide()})}else{$("#firepad2 .CodeMirror").css({"font-size":"1px"});$("#firepad2 .CodeMirror").animate({"font-size":14},1e4,function(){})}},Magnifier:function(e){$("#firepad2 .CodeMirror").clearQueue();$("#firepad2 .CodeMirror").clearQueue();if(e){$("#firepad1 .CodeMirror").css({"font-size":"40px"});$("#firepad1 .CodeMirror").animate({"font-size":14},1e4,function(){$("#user-cover").hide()})}else{$("#firepad2 .CodeMirror").css({"font-size":"40px"});$("#firepad2 .CodeMirror").animate({"font-size":14},1e4,function(){})}}};$(document).ready(function(){$(window).resize(function(){if(!$("#dialog-box").is(":hidden"))popup()});$(window).scroll(function(){if(!$("#dialog-box").is(":hidden"))popup()})});$(function(){getCurrentUser(function(e){if(!e){askUserForName(showMatchModal)}else{showMatchModal()}})})